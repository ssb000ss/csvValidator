# CSV Validator (streaming)

Инструмент для потоковой валидации и «очистки» больших CSV-файлов без загрузки целиком в память. Проект включает:

- CLI-скрипт для обработки файлов построчно с попыткой «склейки» дефектных строк.
- Веб‑интерфейс на Streamlit для загрузки, предпросмотра и запуска CLI с визуальным прогрессом.
- Единую конфигурацию путей и логирования через config.py и .env.

## Возможности
- Автоопределение кодировки (chardet) с фолбэком на UTF-8.
- Автоопределение разделителя (csv.Sniffer + частотный анализ) с приоритетом вариантов > 1 колонки.
- Потоковая обработка: чтение построчно, запись корректных строк в export/, дефектных — в bad/ (и сырых строк в *_raw.txt).
- «Склейка» соседних строк, если по отдельности они не сходятся по числу колонок.
- Унифицированные логи с ротацией в logs/.

## Структура каталогов
- data/ — исходные файлы (в .gitignore)
- export/ — очищенные файлы (в .gitignore)
- bad/ — дефектные строки (в .gitignore)
- logs/ — логи сессий UI и CLI (в .gitignore)
- config.py — конфигурация путей и .env
- streaming_csv_parser.py — CLI‑скрипт
- app_streamlit.py — интерфейс Streamlit

## Требования
- Python 3.11+
- Зависимости из requirements.txt

Установка зависимостей:

```
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

## Конфигурация (.env)
Вы можете переопределить пути (по умолчанию — относительные каталоги проекта):

```
DATA_DIR=./data
EXPORT_DIR=./export
BAD_DIR=./bad
LOGS_DIR=./logs
```

Пути могут быть абсолютными или относительными относительно корня проекта.

## Быстрый старт (CLI)

1. Поместите исходный файл в каталог data/ (не обязательно, можно и любой путь).
2. Запустите обработку, указав входной и выходные файлы:

```
python streaming_csv_parser.py data/input.csv export/input_clean.csv bad/input_bad.csv
```

Опции:
- `--encoding` — кодировка входного (по умолчанию автоопределение)
- `--delimiter` — разделитель входного (по умолчанию автоопределение)
- `--export_delimiter` — разделитель выходного (по умолчанию `~`)
- `--sample_size` — байт для определения кодировки (по умолчанию 10000)
- `--batch_size` — шаг логирования прогресса (по умолчанию 10000)

Выход CLI печатает строку вида `__SUMMARY__ VALID=<n> BAD=<m>` для парсинга в UI.

## Быстрый старт (UI Streamlit)

```
streamlit run app_streamlit.py
```

В UI вы можете:
- Загрузить CSV.
- Посмотреть предпросмотр первых строк.
- Запустить обработку (внутри вызывается CLI через subprocess).
- Отследить прогресс и скачать результаты.

Логи сессии сохраняются в каталоге `logs/`.

## Логирование
- Все логи складываются в `logs/` (см. LOGS_DIR в config.py).
- CLI использует RotatingFileHandler (5MB, 3 бэкапа) + вывод в консоль.
- Streamlit UI пишет сессионные логи в файл `logs/session_<id>_<ts>.log`.

## Контракт по числу колонок
По умолчанию используется «правило 90%»: если ≥ 90% строк имеют модальное число колонок, берём его как ожидаемое. Иначе — число колонок заголовка. Несоответствующие строки попадают в `bad/`, с попыткой предварительной «склейки».

## Демо / GIF
Добавьте в репозиторий демонстрационный GIF работы UI (экранированы чувствительные данные) или создайте его локально:

1. Откройте UI: `streamlit run app_streamlit.py`.
2. Запишите экран (например, macOS: Shift+Cmd+5; Windows: Xbox Game Bar; Linux: Peek/OBS).
3. Сохраните файл в `docs/demo.gif` и добавьте ссылку ниже.

Место для вставки GIF:

![Demo](docs/demo.gif)

## Разработка
- Соблюдайте PEP 8 и короткие, информативные docstring’и.
- Не коммитьте большие файлы данных. Каталоги `data/`, `export/`, `bad/`, `logs/` игнорируются гитом.
- Для изменений путей используйте только config.py.

## Лицензия
Выберите лицензию (например, MIT) и добавьте файл LICENSE. Если не уверены — оставьте проект приватным до выбора.
